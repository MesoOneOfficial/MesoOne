<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MesoOne - USA Severe Weather Tracker</title>
<style>
:root {
    --bg-color: #e1e1e1;
    --text-color: #222;
    --header-bg: #000;
    --header-color: #fbcf2f;
    --tagline-color: #aaaaaa;
    --article-bg: #fff;
    --article-border: #999;
    --footer-bg: #000;
    --footer-color: #fff;
    --link-color: #0066cc;
    --link-hover: #004499;
}
body.dark-mode {
    --bg-color: #1e1e1e;
    --text-color: #e0e0e0;
    --header-bg: #111;
    --header-color: #fbcf2f;
    --tagline-color: #cccccc;
    --article-bg: #222;
    --article-border: #555;
    --footer-bg: #111;
    --footer-color: #f0f0f0;
    --link-color: #66aaff;
    --link-hover: #3399ff;
}

body { font-family: Arial, sans-serif; background: var(--bg-color); color: var(--text-color); margin:0; padding:0; }
header { display:flex; flex-direction:column; align-items:center; background: var(--header-bg); color: var(--header-color); padding:20px; }
.header-top { display:flex; justify-content:space-between; align-items:center; width:100%; max-width:1200px; }
.header-left h1 { margin:0; font-size:2rem; color: var(--header-color); }
.header-left .tagline { margin-top:5px; font-size:0.9rem; color: var(--tagline-color); }
.header-right .logo { height:60px; width:auto; }
#mode-toggle { background:none; border:2px solid var(--header-color); color: var(--header-color); padding:5px 10px; cursor:pointer; font-size:0.9rem; border-radius:4px; }
#mode-toggle:hover { background: var(--header-color); color: var(--header-bg); }

nav { margin-top:15px; text-align:center; }
nav a { color: var(--header-color); text-decoration:none; margin:0 15px; font-weight:bold; }
nav a:hover { color: var(--link-hover); }

main { display:flex; justify-content:center; width:100%; }
.container { display:flex; gap:20px; width:100%; max-width:1200px; margin:30px auto; padding:0 20px; }

.main-content { flex:2; min-width:60%; }
.sidebar { flex:1; min-width:30%; }

article { background: var(--article-bg); padding:20px; margin-bottom:20px; border:2px solid var(--article-border); border-radius:6px; }

h2 { color:#000; }
body.dark-mode h2 { color:#fff; }

#forecast-text { white-space: normal; line-height:1.5; font-family: monospace; background: var(--article-bg); padding:15px; border-radius:5px; border:1px solid var(--article-border); max-height:700px; overflow-y:auto; }
#outlook-map { width:100%; max-width:600px; border:2px solid var(--article-border); border-radius:6px; }

footer { background: var(--footer-bg); color: var(--footer-color); text-align:center; padding:15px; }

@media(max-width:900px){.header-top{flex-direction:column;align-items:center;} nav{margin-top:10px;} .container{flex-direction:column;} .main-content, .sidebar{min-width:100%;}}
</style>
</head>
<body>

<header>
    <div class="header-top">
        <div class="header-left">
            <h1>MesoOne</h1>
            <p class="tagline">Severe weather interception, research and alerts.</p>
        </div>
        <div class="header-right">
            <img src="MesoOneLogo.png" alt="Tornado Tracker Logo" class="logo">
            <button id="mode-toggle">Toggle Dark Mode</button>
        </div>
    </div>
    <nav>
        <a href="index.html">Home</a>
        <a href="usa.html">USA</a>
        <a href="uk.html">UK</a>
        <a href="community.html">Community</a>
    </nav>
</header>

<main>
    <div class="container">
        <section class="main-content">
            <article id="forecast">
                <h2 id="forecast-title">Loading today's severe weather forecast...</h2>
                <p class="meta">Updated daily | Source: NOAA SPC</p>
                <p id="forecast-text">Please wait while we retrieve the official SPC Day 1 Tornado Outlook.</p>
            </article>

            <article>
                <h2>Today's Severe Weather Outlook Map</h2>
                <p class="meta">Updated daily</p>
                <img id="outlook-map" src="https://www.spc.noaa.gov/products/outlook/day1otlk_1200.gif" alt="SPC Day 1 Tornado Outlook">
                <p>If the map does not appear, <a href="https://www.spc.noaa.gov/products/outlook/day1otlk.html" target="_blank" style="color: var(--link-color);">click here to view it on the SPC site</a>.</p>
            </article>

            <article>
                <h2>⚠️ Tornado Alerts</h2>
                <ul id="alerts-list"><li>Loading tornado alerts…</li></ul>
            </article>
        </section>
    </div>
</main>

<footer>
    <p>Please keep in mind that we are not the NWS or NOAA, we just post content.</p>
</footer>

<script>
const modeBtn = document.getElementById('mode-toggle');
modeBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
});

const alertsList = document.getElementById('alerts-list');
const forecastTitle = document.getElementById('forecast-title');
const forecastText = document.getElementById('forecast-text');

// ----------------------------------------------------
// Helper: checks if cached data is still "fresh"
// ----------------------------------------------------
function isFresh(timestamp, minutes) {
    if (!timestamp) return false;
    const now = Date.now();
    return (now - timestamp) < (minutes * 60 * 1000);
}

// ----------------------------------------------------
// Tornado Alerts (weather.gov API)
// Cached for 5 minutes
// ----------------------------------------------------
async function fetchTornadoAlerts() {
    const cacheKey = "tornadoAlertsCache";
    const timeKey = "tornadoAlertsTimestamp";

    const cached = localStorage.getItem(cacheKey);
    const cachedTime = localStorage.getItem(timeKey);

    if (cached && isFresh(cachedTime, 5)) {
        displayTornadoAlerts(JSON.parse(cached));
        return;
    }

    alertsList.innerHTML = "<li>Loading tornado alerts…</li>";

    try {
        const r = await fetch("https://api.weather.gov/alerts/active");
        const data = await r.json();
        const alerts = data.features || [];

        // Cache results
        localStorage.setItem(cacheKey, JSON.stringify(alerts));
        localStorage.setItem(timeKey, Date.now().toString());

        displayTornadoAlerts(alerts);
    } catch {
        alertsList.innerHTML = "<li>Unable to load tornado alerts.</li>";
    }
}

function displayTornadoAlerts(alerts) {
    alertsList.innerHTML = "";
    const tornadoEvents = ['Tornado Warning', 'Tornado Watch'];

    const filtered = alerts.filter(a => tornadoEvents.includes(a.properties.event));

    if (filtered.length === 0) {
        alertsList.innerHTML = "<li>No active tornado alerts at this time.</li>";
        return;
    }

    filtered.forEach(alert => {
        const props = alert.properties;
        const li = document.createElement("li");
        li.innerHTML = `<strong>${props.event}</strong>: ${props.areaDesc} — Expires: ${new Date(props.expires).toLocaleString()}`;
        alertsList.appendChild(li);
    });
}

// ----------------------------------------------------
// Tornado Forecast (SPC)
// Cached for 5 minutes
// ----------------------------------------------------
async function fetchTornadoForecast() {
    const cacheKey = "tornadoForecastCache";
    const timeKey = "tornadoForecastTimestamp";

    const cached = localStorage.getItem(cacheKey);
    const cachedTime = localStorage.getItem(timeKey);

    if (cached && isFresh(cachedTime, 5)) {
        displayForecast(cached);
        return;
    }

    try {
        const response = await fetch("https://www.spc.noaa.gov/products/outlook/day1otlk.html");
        const text = await response.text();
        const match = text.match(/<pre>([\s\S]*?)<\/pre>/i);
        const outlookText = match ? match[1].trim() : "No data available.";

        localStorage.setItem(cacheKey, outlookText);
        localStorage.setItem(timeKey, Date.now().toString());

        displayForecast(outlookText);
    } catch {
        forecastTitle.textContent = "Unable to load today's tornado forecast.";
        forecastText.textContent = "Please check back later or visit the SPC directly.";
    }
}

function displayForecast(text) {
    forecastTitle.textContent = "Today's Severe Weather Forecast";
    forecastText.innerHTML = text.replace(/\n/g, "<br>").replace(/\s{2,}/g, " ");
}

// ----------------------------------------------------
// Run on page load (auto-refresh every 5 minutes)
// ----------------------------------------------------
fetchTornadoAlerts();
fetchTornadoForecast();

// Optional: auto-refresh even if page is open
setInterval(() => {
    fetchTornadoAlerts();
    fetchTornadoForecast();
}, 5 * 60 * 1000); // 5 minutes
</script>
</body>
</html>
