<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MesoOne - USA Severe Weather Tracker</title>
<style>
:root {
    --bg-color: #e1e1e1;
    --text-color: #222;
    --header-color: #fbcf2f;
    --link-color: #0066cc;
    --link-hover: #004499;
}
body.dark-mode {
    --bg-color: #1e1e1e;
    --text-color: #e0e0e0;
    --header-color: #fbcf2f;
    --link-color: #66aaff;
    --link-hover: #3399ff;
}
body {
    font-family: Arial, sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    margin:0; padding:0;
}

/* Banner */
.banner-container {
    position: relative;
    width: 100%;
    overflow: hidden;
}
.banner-image {
    width: 100%;
    height: auto;
    display: block;
}
.header-overlay {
    position: absolute;
    bottom: 0;
    width: 100%;
    display: flex;
    justify-content: center;
    background: rgba(0,0,0,0.3);
    padding: 10px 0;
    box-sizing: border-box;
}
nav a {
    color: var(--header-color);
    text-decoration: none;
    margin: 0 15px;
    font-weight: bold;
}
nav a:hover { color: var(--link-hover); }

/* Layout */
main { width:100%; display:flex; justify-content:center; margin-top:30px; }
.container { display:flex; gap:20px; width:100%; max-width:1200px; padding:0 20px; }
.main-content { flex:2; min-width:60%; }
.sidebar { flex:1; min-width:30%; }
article { background: #fff; padding:20px; margin-bottom:20px; border-radius:6px; border:2px solid #999; }
h2 { color:#000; }
body.dark-mode h2 { color:#fff; }

#forecast-text {
    white-space: normal;
    line-height:1.5;
    font-family: monospace;
    background: #fff;
    padding:15px;
    border-radius:5px;
    border:1px solid #999;
    max-height:700px;
    overflow-y:auto;
}
#outlook-map {
    width:100%;
    max-width:600px;
    border:2px solid #999;
    border-radius:6px;
}

footer {
    background:#000;
    color:#fff;
    text-align:center;
    padding:20px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
}
#mode-toggle {
    background:none;
    border:2px solid var(--header-color);
    color: var(--header-color);
    padding:5px 10px;
    cursor:pointer;
    font-size:0.9rem;
    border-radius:4px;
}
#mode-toggle:hover { background: var(--header-color); color:#000; }

@media(max-width:900px){
    .header-overlay{flex-direction:column;align-items:center;}
    nav{margin-top:5px;}
    .container{flex-direction:column;}
    .main-content, .sidebar{min-width:100%;}
}
</style>
</head>
<body>

<header>
    <div class="banner-container">
        <img src="MesoOnebanner2.png" alt="MesoOne Banner" class="banner-image">
        <div class="header-overlay">
            <nav>
                <a href="index.html">Home</a>
                <a href="usa.html">USA</a>
                <a href="uk.html">UK</a>
                <a href="community.html">Community</a>
            </nav>
        </div>
    </div>
</header>

<main>
    <div class="container">
        <!-- Main Content -->
        <section class="main-content">
            <article id="forecast">
                <h2 id="forecast-title">Loading today's severe weather forecast...</h2>
                <p class="meta">Updated daily | Source: NOAA SPC</p>
                <p id="forecast-text">Please wait while we retrieve the official SPC Day 1 Tornado Outlook.</p>
            </article>

            <article>
                <h2>Today's Severe Weather Outlook Map</h2>
                <p class="meta">Updated daily</p>
                <img id="outlook-map" src="https://www.spc.noaa.gov/products/outlook/day1otlk_1200.gif" alt="SPC Day 1 Tornado Outlook">
                <p>If the map does not appear, <a href="https://www.spc.noaa.gov/products/outlook/day1otlk.html" target="_blank" style="color: var(--link-color);">click here to view it on the SPC site</a>.</p>
            </article>
        </section>

        <!-- Sidebar Warnings -->
        <aside class="sidebar">
            <article>
                <h2>⚠️ Active Tornado Alerts</h2>
                <ul id="alerts-list"><li>Loading tornado alerts…</li></ul>
            </article>
        </aside>
    </div>
</main>

<footer>
    <p>Please keep in mind that we are not the NWS or NOAA, we just post content.</p>
</footer>

<script>
const modeBtn = document.getElementById('mode-toggle');
modeBtn.addEventListener('click', () => document.body.classList.toggle('dark-mode'));

const alertsList = document.getElementById('alerts-list');
const forecastTitle = document.getElementById('forecast-title');
const forecastText = document.getElementById('forecast-text');

/* Tornado Alerts */
async function fetchTornadoAlerts() {
    try {
        const r = await fetch("https://api.weather.gov/alerts/active");
        const data = await r.json();
        const alerts = data.features || [];
        displayTornadoAlerts(alerts);
    } catch {
        alertsList.innerHTML = "<li>Unable to load tornado alerts.</li>";
    }
}
function displayTornadoAlerts(alerts) {
    alertsList.innerHTML = "";
    const types = ['Tornado Warning','Tornado Watch'];
    const filtered = alerts.filter(a => types.includes(a.properties.event));
    if (filtered.length === 0) { alertsList.innerHTML="<li>No active tornado alerts.</li>"; return; }
    filtered.forEach(alert => {
        const p = alert.properties;
        const li = document.createElement("li");
        li.innerHTML = `<strong>${p.event}</strong>: ${p.areaDesc} — Expires: ${new Date(p.expires).toLocaleString()}`;
        alertsList.appendChild(li);
    });
}

/* Forecast Text using NOAA API with correct two-step fetch */
async function fetchTornadoForecast() {
    try {
        // Step 1: Get list of Day 1 Tornado Outlook products
        const response = await fetch("https://api.weather.gov/products/types/TO.day1");
        const data = await response.json();

        if (!data || !data.products || data.products.length === 0) {
            throw new Error("No forecast products available.");
        }

        // Step 2: Get the latest product URL
        const latest = data.products[0];
        const productUrl = latest['@id']; // URL to full text

        // Step 3: Fetch the actual text
        const productResponse = await fetch(productUrl);
        const productData = await productResponse.json();
        const forecastTextContent = productData.productText || "No forecast available.";

        displayForecast(forecastTextContent);
    } catch (err) {
        console.error(err);
        forecastTitle.textContent = "Unable to load today's tornado forecast.";
        forecastText.textContent = "Please check back later.";
    }
}

function displayForecast(text) {
    forecastTitle.textContent = "Today's Severe Weather Forecast";
    forecastText.innerHTML = text.replace(/\n/g,"<br>").replace(/\s{2,}/g," ");
}

/* Refresh Map (15 min) */
function refreshOutlookMap() {
    const img = document.getElementById("outlook-map");
    img.src = "https://www.spc.noaa.gov/products/outlook/day1otlk_1200.gif?cacheBust="+Date.now();
}

/* Initial Load */
fetchTornadoAlerts();
fetchTornadoForecast();
refreshOutlookMap();

/* Auto-refresh intervals */
setInterval(fetchTornadoAlerts, 5*60*1000);    // Alerts 5 min
setInterval(fetchTornadoForecast, 10*60*1000); // Forecast 10 min
setInterval(refreshOutlookMap, 15*60*1000);    // Map 15 min
</script>
</body>
</html>
